apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-app
  labels:
    app: ai-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ai-app
  template:
    metadata:
      labels:
        app: ai-app
    spec:
      serviceAccountName: ai-app-proxy-sa
      containers:
        # --- Container 1: The main app ---
        - name: ai-app
          image: quay.io/jzeng/ai-app:v1.0
          ports:
            - containerPort: 8080
          volumeMounts:
            - name: config-volume
              # Mounts the ConfigMap data into this directory
              mountPath: /config
              readOnly: true
        # --- Container 2: The OpenShift OAuth Proxy ---
        - name: oauth-proxy
          image: registry.redhat.io/openshift4/ose-oauth-proxy:latest
          ports:
            - containerPort: 8443
              name: proxy-https
              protocol: TCP
          args:
            - "--https-address=:8443"
            - "--provider=openshift"
            - "--openshift-service-account=ai-app-proxy-sa"
            - "--cookie-secret-file=/etc/oauth-secret/client-secret"
            # This is key: it forwards traffic to the main app on localhost
            # The --cookie-secret is a random string, which can be generated with openssl rand -base64 32
            - "--upstream=http://127.0.0.1:8080"
            - '--upstream-ca=/var/run/secrets/kubernetes.io/serviceaccount/ca.crt'
            - "--tls-cert=/etc/tls/private/tls.crt"
            - "--tls-key=/etc/tls/private/tls.key"
            - "--cookie-secret=r0mMIoDOBgzdrhLSRCu57g=="
            # This tells the proxy to pass the headers to your app
            - "--pass-basic-auth=false"
            - "--set-xauthrequest=true"
            - "--skip-provider-button=false"
            - "--email-domain=*"
            - "--pass-access-token=true"
            # - "--set-authorization-header=true"
          volumeMounts:
            # Mount the service certs needed for TLS
            - name: proxy-tls
              mountPath: /etc/tls/private
              readOnly: true
            - name: oauth-secret-volume
              mountPath: /etc/oauth-secret
              readOnly: true
      volumes:
        # Volume for your app's config
        - name: config-volume
          configMap:
            name: ai-app-role-config
        # Volume for the proxy's TLS certs (auto-injected by OpenShift)
        - name: proxy-tls
          secret:
            secretName: ai-app-route-tls
        - name: oauth-secret-volume
          secret:
            secretName: ai-app-oauth-client-secret
---
apiVersion: v1
kind: Service
metadata:
  name: ai-app-service
  labels:
    app: ai-app
  # THIS ANNOTATION tells OpenShift to auto-generate the secret
  annotations:
    service.beta.openshift.io/serving-cert-secret-name: ai-app-route-tls
spec:
  ports:
    # The service exposes the PROXY'S port
    - port: 443
      targetPort: 8443
      name: proxy-https
  selector:
    app: ai-app
---
apiVersion: route.openshift.io/v1
kind: Route
metadata:
  name: ai-app-route
  labels:
    app: ai-app
spec:
  to:
    kind: Service
    name: ai-app-service
  port:
    # The route targets the service's port (which is named 'proxy-https')
    targetPort: proxy-https
  tls:
    # 'Reencrypt' means the external route is secure (TLS)
    # and the internal connection to the proxy is ALSO secure (TLS).
    termination: reencrypt
